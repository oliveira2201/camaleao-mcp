# OrÃ¡culo Central â€“ VisÃ£o Geral, Bancos e Status do Projeto  
> VersÃ£o: 0.2 â€“ Roteador IA + Meta Ads + MemÃ³ria em Banco  
> Autor: Wellington (com apoio da IA)

---

## 1. VisÃ£o Geral do OrÃ¡culo Central

O **OrÃ¡culo Central** Ã© o â€œcÃ©rebroâ€ do ecossistema WhatsApp do GestorConecta.

Ele funciona como um **roteador inteligente de conversas**:

- Recebe mensagens do **WhatsApp (Evolution API)**.
- Entende **o que vocÃª quer** (mÃ©tricas de anÃºncios, suporte, vendas etc.).
- Decide **qual mÃ³dulo/fluxo ativar**, por exemplo:
  - `meta_ads` â†’ fluxo de mÃ©tricas de anÃºncios (Meta Ads).
  - `agente_suporte` â†’ fluxo de suporte.
  - `agente_vendas` â†’ fluxo de vendas/planos.
  - `oraculo_checkin` â†’ conversa geral / check-in.
- MantÃ©m **memÃ³ria da conversa** em banco (Postgres), para:
  - saber o que foi perguntado antes;
  - evitar decisÃµes â€œburraâ€ sem contexto;
  - permitir futuros mÃ³dulos de RAG, sessÃµes, etc.

Hoje o OrÃ¡culo Ã© pensado **100% para uso interno** (vocÃª, Wellington, falando com ele pelo WhatsApp).

---

## 2. Objetivos do OrÃ¡culo

1. **Ser seu copiloto de operaÃ§Ã£o**, via WhatsApp:
   - vocÃª fala em linguagem natural: â€œcomo estÃ£o os anÃºncios hoje?â€, â€œver anÃºncios de ontemâ€, â€œquero ver planosâ€.
   - ele interpreta, confirma (quando necessÃ¡rio) e dispara o fluxo certo.

2. **Padronizar a inteligÃªncia de roteamento**:
   - separar o que Ã© **IA (decisÃ£o)** do que Ã© **execuÃ§Ã£o (sub-fluxos)**;
   - manter a IA â€œgenÃ©ricaâ€ e os fluxos especÃ­ficos (Meta Ads, suporte, vendas) em workflows separados.

3. **Construir base para funis de vendas com IA**:
   - o mesmo padrÃ£o pode ser usado para um **subfluxo vendedor**:
     - topo de funil â†’ descoberta;
     - meio â†’ educaÃ§Ã£o / objeÃ§Ãµes;
     - fundo â†’ oferta / fechamento;
   - sem inventar moda: baseado em padrÃµes que o mercado jÃ¡ usa (assistentes, agentes, flows guiados).

---

## 3. Fluxo Alto NÃ­vel (do WhatsApp atÃ© o subfluxo)

1. **Mensagem chega no WhatsApp â†’ Evolution â†’ Webhook**  
   - Endpoint: `POST /webhook/oraculo-central` (exemplo).
   - Nodo `ğŸ¯ Entrada WhatsApp` recebe o payload bruto da Evolution.

2. **ValidaÃ§Ã£o bÃ¡sica**  
   - Nodo `ğŸ”’ ValidaÃ§Ã£o` verifica se veio `instance`, `body`, etc.
   - Se algo crÃ­tico estiver faltando, pode cair em fallback (no futuro).

3. **NormalizaÃ§Ã£o dos dados**  
   - Nodo `ğŸ“„ Normalizar Dados` extrai:
     - `telefone_whatsapp` (remoteJid).
     - `telefone_cliente` (sÃ³ nÃºmeros).
     - `mensagem` (texto principal).
     - `mensagem_atual`.
     - `nome_cliente` (por enquanto fixo: â€œWellington JÃºniorâ€).

4. **SessÃ£o (simulada)**  
   - Nodo `ğŸ” Verificar SessÃ£o (Simulada)`:
     - gera um `sessionId` com base no telefone.
     - marca `sessao_existente = false` (por enquanto sem lÃ³gica real de sessÃ£o).

5. **Preparar contexto base**  
   - Nodo `ğŸ¨ Prep Contexto` define:
     - `canal = 'whatsapp'`
     - `origem = 'usuario'`
     - `tipo_mensagem = 'texto'`
     - garante `mensagem_atual` preenchida.

6. **Log de entrada no banco**  
   - Nodo `ğŸ§¾ Log Entrada UsuÃ¡rio` insere em `oraculo_logs`:
     - `telefone_cliente`
     - `origem = 'usuario'`
     - `mensagem = mensagem_atual`.

7. **Buscar histÃ³rico de conversa**  
   - Nodo `ğŸ” Buscar HistÃ³rico Conversa`:
     - `SELECT` dos Ãºltimos registros do mesmo `telefone_cliente`.
     - limita, por exemplo, aos Ãºltimos 20 logs.

8. **Montar histÃ³rico em texto**  
   - Nodo `ğŸ§± Montar HistÃ³rico p/ IA`:
     - ordena por data;
     - monta um texto estilo:
       - `(usuÃ¡rio) boa tarde`
       - `(oraculo) Pelo que entendi vocÃª quer olhar as mÃ©tricas dos anÃºncios...`
     - popula:
       - `historico_conversa`
       - `historico_formatado`.

9. **Chamar Agente IA (LangChain + OpenAI)**  
   - Nodo `ğŸ¤– Agente IA` recebe:
     - `mensagem_atual`
     - `historico_conversa`
   - Prompt de sistema instrui a IA a devolver **apenas JSON** com:
     - `agente_escolhido`
     - `nivel_confianca`
     - `justificativa`
     - `resposta_texto`
     - `observacoes_internas`
     - `acao` (`conversar`, `confirmar`, `executar`)

10. **Parser de decisÃ£o + regras fixas**  
    - Nodo `ğŸ“€ Parser DecisÃ£o`:
      - faz parse do JSON vindo da IA.
      - aplica regras extras:
        - **Regra Meta Ads (confirmaÃ§Ã£o):**
          - se histÃ³rico contÃ©m pergunta de mÃ©tricas (â€œmÃ©tricas dos anÃºnciosâ€, â€œquer que eu puxe os dados agoraâ€ etc.)
          - e mensagem atual Ã© uma confirmaÃ§Ã£o curta (â€œsimâ€, â€œsim de agoraâ€, â€œsim, de hojeâ€ etc.)
          - entÃ£o forÃ§a:
            - `agente_escolhido = 'meta_ads'`
            - `acao = 'executar'`
        - **Regra palavra-chave Meta Ads:**
          - se mensagem contÃ©m â€œanuncioâ€, â€œanÃºnciosâ€, â€œmeta adsâ€, â€œcampanhaâ€, â€œtrÃ¡fegoâ€ etc.
          - e IA veio com `oraculo_checkin`
          - entÃ£o ajusta:
            - `agente_escolhido = 'meta_ads'`
            - `acao = 'confirmar'` (se ainda nÃ£o for â€œexecutarâ€)
      - resolve tambÃ©m:
        - saudaÃ§Ã£o mais humana;
        - mensagem final para WhatsApp;
        - tipo de saÃ­da:
          - `texto` â†’ sÃ³ responde;
          - `webhook` â†’ chama subfluxo (Meta Ads, etc.).

11. **Log de saÃ­da no banco**  
    - Nodo `ğŸ§¾ Log SaÃ­da OrÃ¡culo` grava:
      - `telefone_cliente`
      - `origem = 'oraculo'`
      - `mensagem` (o texto enviado para o WhatsApp)
      - `agente_escolhido`
      - `acao`
      - `tipo_saida`
      - `fluxo_destino` (URL do webhook, se tiver).

12. **Switch: texto x webhook**  
    - Nodo `Switch` olha `tipo_saida`:
      - se `texto` â†’ envia de volta pelo WhatsApp.
      - se `webhook` â†’ chama o subfluxo (ex.: Meta Ads Metrics).

13. **Subfluxos**  
    - Exemplo jÃ¡ implementado:
      - `meta-ads-metrics`:
        - pega dados da API Meta.
        - monta:
          - 1 mensagem resumo geral.
          - 1 mensagem por campanha ativa.

---

## 4. Banco de Dados â€“ Tabelas e Colunas

### 4.1. Tabela `oraculo_logs`

**FunÃ§Ã£o:**  
Ã‰ a â€œcaixa-pretaâ€ da conversa. Registra tudo que entra e sai do OrÃ¡culo por telefone.

**Esquema sugerido (consolidando o que jÃ¡ usamos):**

```sql
CREATE TABLE oraculo_logs (
  id              BIGSERIAL PRIMARY KEY,
  criado_em       TIMESTAMPTZ NOT NULL DEFAULT NOW(),

  telefone_cliente TEXT NOT NULL,
  origem           TEXT NOT NULL, -- 'usuario' ou 'oraculo'

  mensagem         TEXT NOT NULL,

  agente_escolhido TEXT,          -- meta_ads, agente_suporte, etc.
  acao             TEXT,          -- conversar, confirmar, executar
  tipo_saida       TEXT,          -- texto, webhook
  fluxo_destino    TEXT           -- URL do webhook ou identificador do fluxo
);
